<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HeyHoLetsGo – v1.3.8 Stable</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #ffffff;
      --bg-alt: #f7f9fb;
      --text: #111827;
      --text-light: #6b7280;
      --card: #ffffff;
      --border: #e5e7eb;
      --accent: #ffb443;
      --accent-soft: #ffe0a8;
      --danger: #ef4444;
      --warn: #facc15;
      --success: #22c55e;
    }
    body.dark {
      --bg: #0d1117;
      --bg-alt: #111827;
      --text: #f9fafb;
      --text-light: #9ca3af;
      --card: #1f2937;
      --border: #374151;
      --accent: #ffb443;
      --accent-soft: #7c2d12;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.25s ease, color 0.25s ease;
    }
    .hidden { display: none !important; }

    .app-container {
      max-width: 1080px;
      margin: 0 auto;
      padding: 16px;
    }

    .top-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
    }
    .top-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo {
      height: 32px;
      width: auto;
      object-fit: contain;
    }
    .app-title {
      font-weight: 800;
      font-size: 18px;
    }
    .app-subtitle {
      font-size: 12px;
      color: var(--text-light);
    }

    /* Tabs */
    .tab-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .tab-buttons button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: var(--card);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.1s ease;
    }
    .tab-buttons button.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .card-title {
      font-weight: 700;
      font-size: 14px;
    }
    .card-sub {
      font-size: 12px;
      color: var(--text-light);
    }

    input, select, textarea {
      width: 100%;
      padding: 9px 11px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-alt);
      color: var(--text);
      margin-bottom: 8px;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }

    button.primary {
      width: 100%;
      padding: 10px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 4px;
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }
    button.primary:active {
      transform: scale(0.97);
      box-shadow: 0 0 0 0 transparent;
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .task-item {
      display: flex;
      flex-direction: column;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-alt);
      gap: 6px;
    }
    .task-row-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .task-name {
      font-weight: 600;
      font-size: 13px;
      flex: 1;
    }
    .task-effort {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--card);
      border: 1px solid var(--border);
    }
    .task-row-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .status-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      cursor: pointer;
    }
    .status-none { background: #e5e7eb; color: #111827; }
    .status-progress { background: #fef3c7; color: #92400e; }
    .status-done { background: #bbf7d0; color: #166534; }
    .status-blocked { background: #fee2e2; color: #991b1b; }

    .task-actions {
      display: flex;
      gap: 6px;
    }
    .task-actions button {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--card);
      cursor: pointer;
    }

    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--bg-alt);
      border: 1px solid var(--border);
    }

    .progress-wrapper {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .progress-circle-wrap {
      width: 90px;
      height: 90px;
      position: relative;
    }
    .progress-circle-wrap canvas {
      width: 100% !important;
      height: 100% !important;
    }
    .progress-circle-center {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 12px;
    }
    .progress-label {
      font-size: 11px;
      color: var(--text-light);
    }

    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(28, minmax(0, 1fr));
      gap: 3px;
      margin-top: 8px;
    }
    .heatmap-cell {
      width: 100%;
      padding-top: 100%;
      position: relative;
      border-radius: 3px;
      cursor: pointer;
    }
    .heatmap-cell-inner {
      position: absolute;
      inset: 0;
      border-radius: 3px;
    }
    .heatmap-legend {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-light);
      flex-wrap: wrap;
    }
    .legend-box {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    /* Learning */
    .learning-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .learning-entry {
      border-radius: 12px;
      padding: 10px;
      border: 1px solid var(--border);
      background: var(--bg-alt);
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .flex-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }

    /* Ho-Ho */
    #hohoAssistant {
      position: fixed;
      bottom: 18px;
      right: 18px;
      width: 90px;
      height: auto;
      z-index: 9999;
      cursor: pointer;
      transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    #hohoAssistant:hover {
      transform: translateY(-4px) scale(1.04);
    }

    /* Modal for history detail */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9998;
    }
    .modal {
      width: 100%;
      max-width: 420px;
      background: var(--card);
      border-radius: 18px;
      padding: 16px;
      border: 1px solid var(--border);
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-title {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .modal-subtitle {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 10px;
    }
    .modal-close {
      border: none;
      background: transparent;
      font-size: 14px;
      cursor: pointer;
    }

    @media (max-width: 640px) {
      .progress-wrapper {
        flex-direction: column;
        align-items: flex-start;
      }
      .top-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

<div class="app-container">
  <div class="top-header">
    <div class="top-header-left">
      <!-- Optional logos kalau ada file-nya -->
      <!-- <img src="savvy-logo.png" class="logo" alt="Savvy" /> -->
      <!-- <img src="hoho-logo.png" class="logo" alt="Ho-Ho" /> -->
      <div>
        <div class="app-title">HeyHoLetsGo</div>
        <div class="app-subtitle">Dopamine-based daily tracker</div>
      </div>
    </div>
  </div>

  <div class="tab-buttons">
    <button id="tabBtnTasks" class="active" onclick="showTab('tasks')">Tasks</button>
    <button id="tabBtnLearning" onclick="showTab('learning')">Learning</button>
    <button id="tabBtnSettings" onclick="showTab('settings')">Settings</button>
  </div>

  <!-- TASKS TAB -->
  <div id="tabTasks">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Today’s Dopamine Sparks</div>
          <div class="card-sub">Target minimal 60% per hari</div>
        </div>
      </div>
      <div class="progress-wrapper">
        <div class="progress-circle-wrap">
          <canvas id="taskDopamineChart"></canvas>
          <div class="progress-circle-center">
            <div id="taskDopaminePercent" style="font-weight:700;">0%</div>
            <div class="progress-label">today</div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--text-light);">
          <div><span style="font-weight:600;color:var(--text);">Rules:</span></div>
          <div>• Done = 100% XP task</div>
          <div>• Progress = 20% XP task</div>
          <div>• None / Blocked = 0 XP</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Today’s Tasks</div>
          <div class="card-sub" id="tasksDateLabel"></div>
        </div>
        <div class="badge" id="tasksSummaryBadge">0 done · 0 xp</div>
      </div>
      <input id="taskNameInput" type="text" placeholder="Nama task" />
      <select id="taskEffortInput">
        <option value="1">Effort 1 – kecil</option>
        <option value="2">Effort 2 – sedang</option>
        <option value="3">Effort 3 – berat</option>
      </select>
      <button class="primary" onclick="addTask()">Add Task</button>
      <div class="task-list" id="taskList"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">28-Day Task Heatmap</div>
          <div class="card-sub">Klik hari untuk lihat detail</div>
        </div>
      </div>
      <div class="heatmap-grid" id="taskHeatmap"></div>
      <div class="heatmap-legend">
        <span>Legend:</span>
        <div class="legend-box" style="background:#fee2e2;"></div><span>0–39%</span>
        <div class="legend-box" style="background:#fef3c7;"></div><span>40–79%</span>
        <div class="legend-box" style="background:#bbf7d0;"></div><span>80–100%</span>
      </div>
    </div>
  </div>

  <!-- LEARNING TAB -->
  <div id="tabLearning" class="hidden">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Today’s Learning XP</div>
          <div class="card-sub">Wajib minimal 1 learning per hari</div>
        </div>
        <div class="badge" id="learningTodayXpBadge">0 XP today</div>
      </div>
      <div class="progress-wrapper">
        <div class="progress-circle-wrap">
          <canvas id="learningDopamineChart"></canvas>
          <div class="progress-circle-center">
            <div id="learningDopaminePercent" style="font-weight:700;">0%</div>
            <div class="progress-label">today</div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--text-light);">
          <div>Small: 10 XP</div>
          <div>Medium: 25 XP</div>
          <div>Intensive: 50 XP</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Log Today’s Learning</div>
          <div class="card-sub" id="learningDateLabel"></div>
        </div>
      </div>
      <select id="learningType">
        <option value="hard">Hard Skill</option>
        <option value="soft">Soft Skill</option>
      </select>
      <select id="learningCategory">
        <option value="Tools & Workspace">Tools & Workspace</option>
        <option value="Digital Marketing">Digital Marketing</option>
        <option value="AI Skills">AI Skills</option>
        <option value="Content & Creative">Content & Creative</option>
        <option value="Data Analytics & Research">Data Analytics & Research</option>
        <option value="Finance">Finance</option>
        <option value="HR">HR</option>
        <option value="Sales">Sales</option>
        <option value="Cognitive">Cognitive</option>
        <option value="Interpersonal">Interpersonal</option>
        <option value="Intrapersonal">Intrapersonal</option>
        <option value="Business Acumen">Business Acumen</option>
        <option value="Leadership & Management">Leadership & Management</option>
        <option value="Others">Others</option>
      </select>
      <select id="learningIntensity">
        <option value="small">Small (5–10 menit)</option>
        <option value="medium">Medium (deep dive)</option>
        <option value="intensive">Intensive (1–2 jam)</option>
      </select>
      <textarea id="learningNote" placeholder="Lo belajar apa hari ini & manfaatnya buat kerjaan?"></textarea>
      <button class="primary" onclick="addLearning()">Add Learning</button>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Today’s Learning History</div>
        </div>
      </div>
      <div class="learning-list" id="learningList"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">28-Day Learning Heatmap</div>
          <div class="card-sub">Semakin hijau, semakin niat</div>
        </div>
      </div>
      <div class="heatmap-grid" id="learningHeatmap"></div>
      <div class="heatmap-legend">
        <span>Legend:</span>
        <div class="legend-box" style="background:#fee2e2;"></div><span>0–39%</span>
        <div class="legend-box" style="background:#fef3c7;"></div><span>40–79%</span>
        <div class="legend-box" style="background:#bbf7d0;"></div><span>80–100%</span>
      </div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div id="tabSettings" class="hidden">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Profile</div>
          <div class="card-sub">Nama & posisi akan muncul di report</div>
        </div>
      </div>
      <label style="font-size:12px;">Name</label>
      <input id="userNameInput" type="text" placeholder="Nama lo" />
      <label style="font-size:12px;">Position</label>
      <input id="userPositionInput" type="text" placeholder="Posisi lo di Savvy" />
      <button class="primary" onclick="saveProfile()">Save Profile</button>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Theme</div>
          <div class="card-sub">Light / Dark (Savvy navy)</div>
        </div>
      </div>
      <div class="toggle-row">
        <span style="font-size:13px;">Dark mode</span>
        <button class="task-actions" onclick="toggleTheme()" style="padding:6px 10px;">
          Toggle
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Ho-Ho -->
<img id="hohoAssistant" src="hoho-happy.png" alt="Ho-Ho" />

<!-- Modal container -->
<div id="modalContainer" class="hidden"></div>

<script>
const STORAGE_KEY = "heyho_state_v1_3_8";

let appState = {
  tasks: {},          // { dateKey: [ {id,name,effort,status,createdAt} ] }
  learning: {},       // { dateKey: [ {id,type,category,intensity,note,createdAt} ] }
  theme: "light",
  user: { name: "", position: "" },
  lastOpenDate: null
};

function getTodayKey() {
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, "0");
  const d = String(now.getDate() + 0).padStart(2, "0");
  return `${y}-${m}-${d}`;
}

function shiftDateKey(dateKey, deltaDays) {
  const [y, m, d] = dateKey.split("-").map(x => parseInt(x, 10));
  const dt = new Date(y, m - 1, d + deltaDays);
  const yy = dt.getFullYear();
  const mm = String(dt.getMonth() + 1).padStart(2, "0");
  const dd = String(dt.getDate()).padStart(2, "0");
  return `${yy}-${mm}-${dd}`;
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    appState.tasks = parsed.tasks || {};
    appState.learning = parsed.learning || {};
    appState.theme = parsed.theme || "light";
    appState.user = parsed.user || { name: "", position: "" };
    appState.lastOpenDate = parsed.lastOpenDate || null;
  } catch (e) {
    console.error("loadState error", e);
  }
}

function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
  } catch (e) {
    console.error("saveState error", e);
  }
}

function generateId() {
  return "id-" + Math.random().toString(36).substring(2, 9);
}

/* THEME */

function applyTheme(theme) {
  if (theme === "dark") {
    document.body.classList.add("dark");
  } else {
    document.body.classList.remove("dark");
  }
}

function toggleTheme() {
  appState.theme = appState.theme === "dark" ? "light" : "dark";
  applyTheme(appState.theme);
  saveState();
}

/* TABS */

function showTab(tab) {
  document.getElementById("tabTasks").classList.add("hidden");
  document.getElementById("tabLearning").classList.add("hidden");
  document.getElementById("tabSettings").classList.add("hidden");
  document.getElementById("tabBtnTasks").classList.remove("active");
  document.getElementById("tabBtnLearning").classList.remove("active");
  document.getElementById("tabBtnSettings").classList.remove("active");

  if (tab === "tasks") {
    document.getElementById("tabTasks").classList.remove("hidden");
    document.getElementById("tabBtnTasks").classList.add("active");
  } else if (tab === "learning") {
    document.getElementById("tabLearning").classList.remove("hidden");
    document.getElementById("tabBtnLearning").classList.add("active");
  } else if (tab === "settings") {
    document.getElementById("tabSettings").classList.remove("hidden");
    document.getElementById("tabBtnSettings").classList.add("active");
  }
}

/* TASKS */

function getTodayTasks() {
  const key = getTodayKey();
  if (!Array.isArray(appState.tasks[key])) {
    appState.tasks[key] = [];
  }
  return appState.tasks[key];
}

function getTaskBaseXp(effort) {
  const e = parseInt(effort, 10) || 1;
  if (e === 1) return 10;
  if (e === 2) return 20;
  if (e === 3) return 30;
  return 10;
}

function getTaskEffectiveXp(task) {
  const base = getTaskBaseXp(task.effort);
  if (task.status === "done") return base;
  if (task.status === "progress") return Math.round(base * 0.2);
  return 0;
}

function computeDayDopamine(dateKey) {
  const tasks = appState.tasks[dateKey] || [];
  const totalBase = tasks.reduce((sum, t) => sum + getTaskBaseXp(t.effort), 0);
  if (totalBase === 0) return 0;
  const totalEff = tasks.reduce((sum, t) => sum + getTaskEffectiveXp(t), 0);
  const pct = (totalEff / totalBase) * 100;
  return Math.max(0, Math.min(100, Math.round(pct)));
}

function addTask() {
  const nameEl = document.getElementById("taskNameInput");
  const effEl = document.getElementById("taskEffortInput");
  const name = (nameEl.value || "").trim();
  const effort = parseInt(effEl.value, 10) || 1;
  if (!name) return;

  const key = getTodayKey();
  if (!Array.isArray(appState.tasks[key])) {
    appState.tasks[key] = [];
  }
  appState.tasks[key].push({
    id: generateId(),
    name,
    effort,
    status: "none",
    createdAt: new Date().toISOString()
  });
  saveState();
  nameEl.value = "";
  effEl.value = "1";
  renderTasksForToday();
  renderTaskDopamine();
  renderTaskHeatmap();
}

function cycleStatus(task) {
  const order = ["none", "progress", "done", "blocked"];
  const idx = order.indexOf(task.status);
  const next = order[(idx + 1) % order.length];
  task.status = next;
}

function editTaskName(taskId) {
  const key = getTodayKey();
  const tasks = appState.tasks[key] || [];
  const t = tasks.find(x => x.id === taskId);
  if (!t) return;
  const newName = prompt("Edit task name:", t.name);
  if (newName === null) return;
  const trimmed = newName.trim();
  if (!trimmed) return;
  t.name = trimmed;
  saveState();
  renderTasksForToday();
  renderTaskDopamine();
  renderTaskHeatmap();
}

function editTaskEffort(taskId) {
  const key = getTodayKey();
  const tasks = appState.tasks[key] || [];
  const t = tasks.find(x => x.id === taskId);
  if (!t) return;
  const newEff = prompt("Edit effort (1–3):", String(t.effort || 1));
  if (newEff === null) return;
  const eff = parseInt(newEff, 10);
  if (![1,2,3].includes(eff)) return;
  t.effort = eff;
  saveState();
  renderTasksForToday();
  renderTaskDopamine();
  renderTaskHeatmap();
}

function deleteTask(taskId) {
  const key = getTodayKey();
  let tasks = appState.tasks[key] || [];
  tasks = tasks.filter(t => t.id !== taskId);
  appState.tasks[key] = tasks;
  saveState();
  renderTasksForToday();
  renderTaskDopamine();
  renderTaskHeatmap();
}

function renderTasksForToday() {
  const key = getTodayKey();
  const list = document.getElementById("taskList");
  list.innerHTML = "";
  const tasks = appState.tasks[key] || [];

  const dateLabel = document.getElementById("tasksDateLabel");
  const now = new Date(key + "T00:00:00");
  dateLabel.textContent = now.toLocaleDateString("en-GB", { weekday: "short", day: "2-digit", month: "short" });

  let doneCount = 0;
  let totalXp = 0;

  tasks.forEach(t => {
    if (t.status === "done") doneCount++;
    totalXp += getTaskEffectiveXp(t);

    const item = document.createElement("div");
    item.className = "task-item";

    const topRow = document.createElement("div");
    topRow.className = "task-row-top";

    const nameSpan = document.createElement("div");
    nameSpan.className = "task-name";
    nameSpan.textContent = t.name;

    const effortSpan = document.createElement("div");
    effortSpan.className = "task-effort";
    effortSpan.textContent = "Effort " + (t.effort || 1);

    topRow.appendChild(nameSpan);
    topRow.appendChild(effortSpan);

    const bottomRow = document.createElement("div");
    bottomRow.className = "task-row-bottom";

    const statusBtn = document.createElement("div");
    statusBtn.className = "status-pill status-" + (t.status || "none");
    const labelMap = {
      none: "Todo",
      progress: "Progress",
      done: "Done",
      blocked: "Blocked"
    };
    statusBtn.textContent = labelMap[t.status || "none"];
    statusBtn.onclick = () => {
      cycleStatus(t);
      saveState();
      renderTasksForToday();
      renderTaskDopamine();
      renderTaskHeatmap();
    };

    const actionsDiv = document.createElement("div");
    actionsDiv.className = "task-actions";

    const editNameBtn = document.createElement("button");
    editNameBtn.textContent = "Edit";
    editNameBtn.onclick = () => editTaskName(t.id);

    const editEffBtn = document.createElement("button");
    editEffBtn.textContent = "Effort";
    editEffBtn.onclick = () => editTaskEffort(t.id);

    const delBtn = document.createElement("button");
    delBtn.textContent = "Del";
    delBtn.onclick = () => deleteTask(t.id);

    actionsDiv.appendChild(editNameBtn);
    actionsDiv.appendChild(editEffBtn);
    actionsDiv.appendChild(delBtn);

    bottomRow.appendChild(statusBtn);
    bottomRow.appendChild(actionsDiv);

    item.appendChild(topRow);
    item.appendChild(bottomRow);
    list.appendChild(item);
  });

  const badge = document.getElementById("tasksSummaryBadge");
  badge.textContent = `${doneCount} done · ${totalXp} xp`;
}

/* CARRY-OVER */

function carryOverFromYesterday() {
  const today = getTodayKey();

  if (appState.lastOpenDate === today) {
    // Hari ini sudah pernah di-handle, jangan carry lagi
    return;
  }

  const yesterday = shiftDateKey(today, -1);
  const yTasks = appState.tasks[yesterday] || [];
  const todayTasks = appState.tasks[today] || [];

  const carryList = [];

  yTasks.forEach(t => {
    if (
      t.status === "none" ||
      t.status === "" ||
      t.status === "progress" ||
      t.status === "blocked"
    ) {
      // cek duplicate berdasarkan name + effort + status none
      const already = todayTasks.find(
        x => x.name === t.name && x.effort === t.effort && x.status === "none"
      );
      if (!already) {
        carryList.push({
          id: generateId(),
          name: t.name,
          effort: t.effort || 1,
          status: "none",
          createdAt: new Date().toISOString()
        });
      }
    }
  });

  appState.tasks[today] = [...carryList, ...todayTasks];
  appState.lastOpenDate = today;
  saveState();
}

/* HEATMAP TASKS */

function renderTaskHeatmap() {
  const container = document.getElementById("taskHeatmap");
  container.innerHTML = "";
  const today = getTodayKey();

  for (let i = 27; i >= 0; i--) {
    const dateKey = shiftDateKey(today, -i);
    const pct = computeDayDopamine(dateKey);
    let color = "#e5e7eb";
    if (pct >= 80) color = "#bbf7d0";      // green
    else if (pct >= 40) color = "#fef3c7"; // yellow
    else if (pct > 0) color = "#fee2e2";   // red

    const cell = document.createElement("div");
    cell.className = "heatmap-cell";
    const inner = document.createElement("div");
    inner.className = "heatmap-cell-inner";
    inner.style.background = pct === 0 ? "#f3f4f6" : color;

    cell.appendChild(inner);
    cell.title = `${dateKey} – ${pct}%`;
    cell.onclick = () => openTaskHistoryModal(dateKey);

    container.appendChild(cell);
  }
}

function openTaskHistoryModal(dateKey) {
  const tasks = appState.tasks[dateKey] || [];
  const container = document.getElementById("modalContainer");
  container.innerHTML = "";
  container.classList.remove("hidden");

  const backdrop = document.createElement("div");
  backdrop.className = "modal-backdrop";

  const modal = document.createElement("div");
  modal.className = "modal";

  const headerRow = document.createElement("div");
  headerRow.className = "flex-between";
  const title = document.createElement("div");
  title.className = "modal-title";
  title.textContent = "Task history – " + dateKey;
  const closeBtn = document.createElement("button");
  closeBtn.className = "modal-close";
  closeBtn.textContent = "×";
  closeBtn.onclick = () => container.classList.add("hidden");

  headerRow.appendChild(title);
  headerRow.appendChild(closeBtn);

  const sub = document.createElement("div");
  sub.className = "modal-subtitle";
  const pct = computeDayDopamine(dateKey);
  sub.textContent = `Dopamine: ${pct}%`;

  modal.appendChild(headerRow);
  modal.appendChild(sub);

  if (tasks.length === 0) {
    const empty = document.createElement("div");
    empty.style.fontSize = "12px";
    empty.style.color = "var(--text-light)";
    empty.textContent = "No tasks logged on this day.";
    modal.appendChild(empty);
  } else {
    tasks.forEach(t => {
      const box = document.createElement("div");
      box.className = "task-item";
      const row1 = document.createElement("div");
      row1.className = "task-row-top";

      const n = document.createElement("div");
      n.className = "task-name";
      n.textContent = t.name;

      const e = document.createElement("div");
      e.className = "task-effort";
      e.textContent = "Effort " + (t.effort || 1);

      row1.appendChild(n);
      row1.appendChild(e);

      const row2 = document.createElement("div");
      row2.className = "task-row-bottom";
      const st = document.createElement("div");
      st.className = "status-pill status-" + (t.status || "none");
      const labelMap = { none: "Todo", progress: "Progress", done: "Done", blocked: "Blocked" };
      st.textContent = labelMap[t.status || "none"];
      row2.appendChild(st);

      box.appendChild(row1);
      box.appendChild(row2);
      modal.appendChild(box);
    });
  }

  backdrop.appendChild(modal);
  container.appendChild(backdrop);
}

/* DOPAMINE CHART TASK */

let taskChart = null;
let learningChart = null;

function renderTaskDopamine() {
  const today = getTodayKey();
  const pct = computeDayDopamine(today);

  const ctx = document.getElementById("taskDopamineChart").getContext("2d");
  if (taskChart) {
    taskChart.destroy();
  }
  taskChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Dopamine", "Remaining"],
      datasets: [{
        data: [pct, Math.max(0, 100 - pct)],
        borderWidth: 0
      }]
    },
    options: {
      cutout: "70%",
      plugins: { legend: { display: false }, tooltip: { enabled: false } }
    }
  });

  const percentDom = document.getElementById("taskDopaminePercent");
  percentDom.textContent = pct + "%";
  if (pct >= 80) {
    percentDom.style.color = "var(--success)";
  } else if (pct >= 40) {
    percentDom.style.color = "var(--warn)";
  } else {
    percentDom.style.color = "var(--danger)";
  }
}

/* LEARNING */

function getTodayLearning() {
  const key = getTodayKey();
  if (!Array.isArray(appState.learning[key])) {
    appState.learning[key] = [];
  }
  return appState.learning[key];
}

function learningXpIntensity(intensity) {
  if (intensity === "small") return 10;
  if (intensity === "medium") return 25;
  if (intensity === "intensive") return 50;
  return 10;
}

function computeLearningDopamine(dateKey) {
  const entries = appState.learning[dateKey] || [];
  if (entries.length === 0) return 0;
  const total = entries.reduce((sum, e) => sum + learningXpIntensity(e.intensity), 0);
  // target misal 50 xp
  const pct = (total / 50) * 100;
  return Math.max(0, Math.min(100, Math.round(pct)));
}

function addLearning() {
  const typeEl = document.getElementById("learningType");
  const catEl = document.getElementById("learningCategory");
  const intEl = document.getElementById("learningIntensity");
  const noteEl = document.getElementById("learningNote");

  const type = typeEl.value;
  const category = catEl.value;
  const intensity = intEl.value;
  const note = (noteEl.value || "").trim();
  if (!note) return;

  const key = getTodayKey();
  if (!Array.isArray(appState.learning[key])) {
    appState.learning[key] = [];
  }
  appState.learning[key].push({
    id: generateId(),
    type,
    category,
    intensity,
    note,
    createdAt: new Date().toISOString()
  });

  noteEl.value = "";
  saveState();
  renderLearningForToday();
  renderLearningDopamine();
  renderLearningHeatmap();
}

function deleteLearning(id) {
  const key = getTodayKey();
  let list = appState.learning[key] || [];
  list = list.filter(e => e.id !== id);
  appState.learning[key] = list;
  saveState();
  renderLearningForToday();
  renderLearningDopamine();
  renderLearningHeatmap();
}

function renderLearningForToday() {
  const key = getTodayKey();
  const listEl = document.getElementById("learningList");
  listEl.innerHTML = "";

  const entries = appState.learning[key] || [];
  const dateLabel = document.getElementById("learningDateLabel");
  const d = new Date(key + "T00:00:00");
  dateLabel.textContent = d.toLocaleDateString("en-GB", { weekday: "short", day: "2-digit", month: "short" });

  let todayXp = 0;

  entries.forEach(e => {
    todayXp += learningXpIntensity(e.intensity);

    const box = document.createElement("div");
    box.className = "learning-entry";

    const rowTop = document.createElement("div");
    rowTop.className = "flex-between";

    const left = document.createElement("div");
    left.textContent = `${e.type === "hard" ? "Hard" : "Soft"} – ${e.category}`;

    const delBtn = document.createElement("button");
    delBtn.textContent = "Del";
    delBtn.style.fontSize = "11px";
    delBtn.style.padding = "2px 6px";
    delBtn.style.borderRadius = "8px";
    delBtn.style.border = "1px solid var(--border)";
    delBtn.style.background = "var(--card)";
    delBtn.onclick = () => deleteLearning(e.id);

    rowTop.appendChild(left);
    rowTop.appendChild(delBtn);

    const noteDiv = document.createElement("div");
    noteDiv.textContent = e.note;

    const meta = document.createElement("div");
    meta.style.fontSize = "11px";
    meta.style.color = "var(--text-light)";
    meta.textContent = `Intensity: ${e.intensity}`;

    box.appendChild(rowTop);
    box.appendChild(noteDiv);
    box.appendChild(meta);
    listEl.appendChild(box);
  });

  const badge = document.getElementById("learningTodayXpBadge");
  badge.textContent = `${todayXp} XP today`;
}

/* LEARNING DOPAMINE CHART */

function renderLearningDopamine() {
  const today = getTodayKey();
  const pct = computeLearningDopamine(today);

  const ctx = document.getElementById("learningDopamineChart").getContext("2d");
  if (learningChart) {
    learningChart.destroy();
  }
  learningChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Learning", "Remaining"],
      datasets: [{
        data: [pct, Math.max(0, 100 - pct)],
        borderWidth: 0
      }]
    },
    options: {
      cutout: "70%",
      plugins: { legend: { display: false }, tooltip: { enabled: false } }
    }
  });

  const dom = document.getElementById("learningDopaminePercent");
  dom.textContent = pct + "%";
  if (pct >= 80) dom.style.color = "var(--success)";
  else if (pct >= 40) dom.style.color = "var(--warn)";
  else dom.style.color = "var(--danger)";
}

/* LEARNING HEATMAP */

function renderLearningHeatmap() {
  const container = document.getElementById("learningHeatmap");
  container.innerHTML = "";
  const today = getTodayKey();

  for (let i = 27; i >= 0; i--) {
    const dateKey = shiftDateKey(today, -i);
    const pct = computeLearningDopamine(dateKey);
    let color = "#e5e7eb";
    if (pct >= 80) color = "#bbf7d0";
    else if (pct >= 40) color = "#fef3c7";
    else if (pct > 0) color = "#fee2e2";

    const cell = document.createElement("div");
    cell.className = "heatmap-cell";
    const inner = document.createElement("div");
    inner.className = "heatmap-cell-inner";
    inner.style.background = pct === 0 ? "#f3f4f6" : color;
    cell.appendChild(inner);
    cell.title = `${dateKey} – ${pct}%`;
    cell.onclick = () => openLearningHistoryModal(dateKey);
    container.appendChild(cell);
  }
}

function openLearningHistoryModal(dateKey) {
  const entries = appState.learning[dateKey] || [];
  const container = document.getElementById("modalContainer");
  container.innerHTML = "";
  container.classList.remove("hidden");

  const backdrop = document.createElement("div");
  backdrop.className = "modal-backdrop";

  const modal = document.createElement("div");
  modal.className = "modal";

  const headerRow = document.createElement("div");
  headerRow.className = "flex-between";
  const title = document.createElement("div");
  title.className = "modal-title";
  title.textContent = "Learning history – " + dateKey;
  const closeBtn = document.createElement("button");
  closeBtn.className = "modal-close";
  closeBtn.textContent = "×";
  closeBtn.onclick = () => container.classList.add("hidden");
  headerRow.appendChild(title);
  headerRow.appendChild(closeBtn);

  const sub = document.createElement("div");
  sub.className = "modal-subtitle";
  const pct = computeLearningDopamine(dateKey);
  sub.textContent = `Learning dopamine: ${pct}%`;

  modal.appendChild(headerRow);
  modal.appendChild(sub);

  if (entries.length === 0) {
    const empty = document.createElement("div");
    empty.style.fontSize = "12px";
    empty.style.color = "var(--text-light)";
    empty.textContent = "No learning logged on this day.";
    modal.appendChild(empty);
  } else {
    entries.forEach(e => {
      const box = document.createElement("div");
      box.className = "learning-entry";
      const metaRow = document.createElement("div");
      metaRow.textContent = `${e.type === "hard" ? "Hard" : "Soft"} – ${e.category} (${e.intensity})`;
      const noteDiv = document.createElement("div");
      noteDiv.textContent = e.note;
      box.appendChild(metaRow);
      box.appendChild(noteDiv);
      modal.appendChild(box);
    });
  }

  backdrop.appendChild(modal);
  container.appendChild(backdrop);
}

/* PROFILE */

function saveProfile() {
  const name = document.getElementById("userNameInput").value || "";
  const position = document.getElementById("userPositionInput").value || "";
  appState.user = { name, position };
  saveState();
  alert("Profile saved.");
}

function loadProfileIntoUI() {
  document.getElementById("userNameInput").value = appState.user.name || "";
  document.getElementById("userPositionInput").value = appState.user.position || "";
}

/* HO-HO idle bounce */

function scheduleHohoIdle() {
  const el = document.getElementById("hohoAssistant");
  if (!el) return;
  setInterval(() => {
    el.style.transform = "translateY(-6px) scale(1.04)";
    setTimeout(() => {
      el.style.transform = "translateY(0) scale(1)";
    }, 300);
  }, 6000);
}

/* INIT */

document.addEventListener("DOMContentLoaded", () => {
  loadState();
  applyTheme(appState.theme || "light");

  const today = getTodayKey();
  if (!appState.lastOpenDate) {
    appState.lastOpenDate = today;
    saveState();
  } else if (appState.lastOpenDate !== today) {
    carryOverFromYesterday();
  }

  renderTasksForToday();
  renderTaskDopamine();
  renderTaskHeatmap();
  renderLearningForToday();
  renderLearningDopamine();
  renderLearningHeatmap();
  loadProfileIntoUI();
  scheduleHohoIdle();
});
</script>

</body>
</html>
